---
- name: Build snmpd.conf directory
  ansible.builtin.file:
    path: /usr/local/etc/snmp/
    state: directory
    mode: u+rw,g-wx,o-rw
  become: true
  notify: "netsnmp_configuration_change"

- name: Copy snmp configuration file
  ansible.builtin.copy:
    src: conf_snmpd.conf
    dest: /usr/local/etc/snmp/snmpd.conf
    mode: u+rw,g-wx,o-rw
  become: true
  notify: "netsnmp_configuration_change"

- name: Copy snmp user file if nonexistant
  ansible.builtin.copy:
    src: user_snmpd.conf
    dest: /var/lib/snmp/snmpd.conf
    force: false
    mode: u+rw,g-wx,o-rw
  become: true
  notify: "netsnmp_configuration_change"

- name: Copy the snmpd service file
  ansible.builtin.copy:
    src: snmpd.service
    dest: /etc/systemd/system/snmpd.service
    mode: u+rw,g-wx,o-rw
  become: true
  notify: "netsnmp_configuration_change"

- name: Execute the command in local shell
  ansible.builtin.shell:
    cmd: pwd

- name: check the snmpd.conf file
  ansible.builtin.shell:
    cmd: sudo cat /usr/local/etc/snmp/snmpd.conf

- name: Enable ports in firewall
  ansible.builtin.shell:
    cmd: sudo ufw allow 161/udp
  ignore_errors: true

- name: Execute the snmp command in local shell
  ansible.builtin.shell:
    cmd: snmpwalk -v2c -c public localhost 1.3.6.1.2.1.1

- name: Run handlers if needed
  ansible.builtin.meta: flush_handlers
